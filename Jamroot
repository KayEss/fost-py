path-constant TOP : . ;
include $(TOP)/../boost-version.jam ;

using python ;

project
    :
        requirements
        <include>$(BOOST_HEADERS)
        <target-os>windows:<include>../OpenSSL/install/include/
        <include>../fost-base/Cpp/include/
        <include>../fost-orm/Cpp/include/
        <threading>multi
        <runtime-link>shared

        <target-os>windows:<exception-handling>on
        <target-os>windows:<asynch-exceptions>on
        <target-os>windows:<extern-c-nothrow>off
        <target-os>windows:<debug-symbols>on
        <target-os>windows:<debug-store>database

        <target-os>windows:<define>WIN32
        <target-os>windows:<define>_AFXDLL
        <target-os>windows:<define>UNICODE
        <target-os>windows:<define>_UNICODE
    :
        default-build debug
    :
        build-dir $(BUILD_DIRECTORY)
    ;

# A little "rule" (function) to clean up the syntax of declaring tests
# of these extension modules.
rule run-test ( test-name : sources + )
{
    import testing ;
    testing.make-test run-pyd : $(sources) : : $(test-name) ;
}

# An install rule for the Python libs
rule py-install ( pyd : location )
{
    install ../../../dist/lib :
            $(pyd)
        :
            <target-os>linux:<install-type>LIB
            <target-os>linux:<install-dependencies>on
            <target-os>windows:<install-type>XXX
        ;

    install ../../../dist/bin :
            $(pyd)
        :
            <target-os>windows:<install-type>LIB
            <target-os>windows:<install-dependencies>on
        ;

    local loc = "../../../dist/lib/python/site-packages/" $(location) ;
    install $(loc:J) : $(pyd) ;
}

build-project Cpp/fost-python-test/ ;
build-project Cpp/fost-crypto-py/ ;
build-project Cpp/fost-internet-py/ ;
build-project Cpp/fost-json-py/ ;
build-project Cpp/fost-settings-py/ ;
build-project Cpp/fost-fpython/ ;
build-project Python/ ;

import path ;
install ../dist/lib/python/site-packages/Fost
    :
        [ path.glob-tree Python/Fost : *.* : .svn *.pyc *.so ]
    :
        <install-source-root>Python/Fost
    ;
